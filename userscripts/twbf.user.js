// ==UserScript==
// @name            TW Best Friends
// @description     Sending tamboola currency made easier
// @author          xShteff, Diggo11
// @match           https://*.the-west.net/game.php*
// @match           https://*.the-west.de/game.php*
// @match           https://*.the-west.pl/game.php*
// @match           https://*.the-west.nl/game.php*
// @match           https://*.the-west.se/game.php*
// @match           https://*.the-west.ro/game.php*
// @match           https://*.the-west.com.pt/game.php*
// @match           https://*.the-west.cz/game.php*
// @match           https://*.the-west.es/game.php*
// @match           https://*.the-west.ru/game.php*
// @match           https://*.the-west.com.br/game.php*
// @match           https://*.the-west.org/game.php*
// @match           https://*.the-west.hu/game.php*
// @match           https://*.the-west.gr/game.php*
// @match           https://*.the-west.dk/game.php*
// @match           https://*.the-west.sk/game.php*
// @match           https://*.the-west.fr/game.php*
// @match           https://*.the-west.it/game.php*
// @grant           none
// @downloadURL     https://xshteff.github.io/userscripts/twbf.user.js
// @updateURL       https://xshteff.github.io/userscripts/twbf.user.js
// @version         1
// @run-at          document-end
// ==/UserScript==

var friends={};var lastSent={};var newLogs=true;var logsMetadata=null;var playerLogs=null;var dropTypeLogs=null;var logsLocked=false;function getActiveSesKeys(){return Object.keys(Game.sesData);}
function timeUntilSesReady(friendId){if(!lastSent.hasOwnProperty(friendId)){return 0;}
var yesterday=Date.now()/1000-3600*23;return Math.max(0,Math.floor(lastSent[friendId]-yesterday));}
function getSesReadyCount(){var count=0;$.each(friends,function(playerId,client){if(timeUntilSesReady(playerId)===0){count++;}});return count;}
function getFriendCount(){return Object.keys(friends).length;}
function getFriendsList(){return new Promise(function(resolve,reject){Ajax.remoteCallMode('friendsbar','search',{search_type:'friends'},function(data){if(data.error){return reject(data.msg);}
$.each(data.players,function(i,client){if(client.player_id!==Character.playerId){friends[client.player_id]=west.storage.FriendsBar.prototype.normalizeAvatars_(client,i);delete friends[client.player_id].experience;delete friends[client.player_id].x;delete friends[client.player_id].y;}});var sesKey=getActiveSesKeys()[0];$.each(data.eventActivations,function(i,eventActivation){if(eventActivation.event_name===sesKey){lastSent[eventActivation.friend_id]=eventActivation.activation_time;}});return resolve(data.msg);});});}
function getSesSmalestTimer(){var count=0;var smallestTimer;$.each(friends,function(playerId,client){if(count==0)
smallestTimer=timeUntilSesReady(playerId);if(timeUntilSesReady(playerId)<smallestTimer)
smallestTimer=timeUntilSesReady(playerId);count++;});return smallestTimer;}
function sendSesCurrency(friendId){return new Promise(function(resolve,reject){Ajax.remoteCall('friendsbar','event',{player_id:friendId,event:getActiveSesKeys()[0]},function(data){if(data.error){return reject(data.msg);}
lastSent[friendId]=data.activationTime;setTimeout(function(){updateCounter();updateCounterTimer();},1000);return resolve(data.msg);});});}
function processLogs(background){if(logsLocked)throw new Error("Please don't try and process the logs twice at the same time.");if(!newLogs)return Promise.resolve();logsLocked=true;loadLogs();var sesKey=getActiveSesKeys()[0];if(sesKey!==logsMetadata.sesKey){playerLogs={};dropTypeLogs={};logsMetadata.sesKey=sesKey;}
return new Promise(function(resolve,reject){var generator=processLogsBatches(sesKey,background,resolve,reject);generator.next();generator.next(()=>generator.next());});}
function*processLogsBatches(sesKey,background,resolve,reject){var callback=yield;var stats={newest:logsMetadata.newestSeen||0,hasNext:true};var page=1;do{yield processLogBatch(sesKey,page++,stats,callback,background);}while(stats.hasNext);logsMetadata.newestSeen=stats.newest;saveLogs();newLogs=false;logsLocked=false;return resolve();}
function processLogBatch(sesKey,page,stats,callback,background){Ajax.remoteCallMode('ses','log',{ses_id:sesKey,page:page,limit:100},function(data){if(data.error){logsLocked=false;return reject(data.msg);}
stats.hasNext=!data.entries.some(function(entry,i){if(entry.date<=logsMetadata.newestSeen){return true;}else if(i===0&&entry.date>stats.newest){stats.newest=entry.date;}
dropTypeLogs[entry.type]=(dropTypeLogs[entry.type]||0)+ +entry.value;if(entry.type==='friendDrop'){var senderId=JSON.parse(entry.details).player_id;if(playerLogs.hasOwnProperty(senderId)){playerLogs[senderId].total+=+entry.value;playerLogs[senderId].frequency.push(entry.date);}else{playerLogs[senderId]={total:+entry.value,frequency:[entry.date]};}}})&&data.hasNext;if(background){setTimeout(callback,1000);}else{callback();}});}
function loadLogs(){logsMetadata=JSON.parse(localStorage.getItem('xshteff.betterfriends.logsMetadata'))||{};playerLogs=JSON.parse(localStorage.getItem('xshteff.betterfriends.playerLogs'))||{};dropTypeLogs=JSON.parse(localStorage.getItem('xshteff.betterfriends.dropTypeLogs'))||{};}
function saveLogs(){var prefix='xshteff.betterfriends.';localStorage.setItem(prefix+'logsMetadata',JSON.stringify(logsMetadata));localStorage.setItem(prefix+'playerLogs',JSON.stringify(playerLogs));localStorage.setItem(prefix+'dropTypeLogs',JSON.stringify(dropTypeLogs));}
function initialiseScript(){var sesKeys=getActiveSesKeys();if(sesKeys.length===0)return;getFriendsList().then(function(){getSesReadyCount();getFriendCount();return processLogs(true)}).then(initialiseCounter);EventHandler.listen('friend_added',function(client){friends[client.playerId]={avatar:client.avatar,class:client.charClass,level:client.level,name:client.pname,player_id:client.playerId,profession_id:client.professionId,subclass:client.subClass};setTimeout(updateCounter,1000);});EventHandler.listen('friend_removed',function(friendId){delete friends[friendId];setTimeout(updateCounter,1000);});EventHandler.listen(Game.sesData[sesKeys[0]].counter.key,function(amount){newLogs=true;});}
var generateSendLink=function(pid){return $('<a></a>').text(Game.sesData[getActiveSesKeys()[0]].friendsbar.label).click(function(){sendSesCurrency(pid).then(msg=>MessageSuccess(msg).show()).catch(msg=>MessageError(msg).show());$(this).parent().parent().remove();});};var generatePlayerLink=function(pid){return $('<a></a>').text(friends[pid].name).click(function(){var selectbox=new west.gui.Selectbox();javascript:void(PlayerProfileWindow.open(parseInt(pid)));});}
var generateDeleteFriendLink=function(pid){return $('<img>').attr({'src':'https://westens.innogamescdn.com/images/icons/delete.png','title':'<span>Remove friend</span>','id':'xsht_remove_'+pid}).click(function(){new west.gui.Dialog("Remove friend","Do you really want to delete this player from the list?").setIcon(west.gui.Dialog.SYS_QUESTION).addButton("yes",function(){Ajax.remoteCall('character','cancel_friendship',{friend_id:pid},function(json){if(json["result"]){new UserMessage("Friend removed from your list.",UserMessage.TYPE_SUCCESS).show();$("div.friendData_"+pid,FriendslistWindow.DOM).remove();$('#xsht_remove_'+pid).parent().parent().remove();Chat.Friendslist.removeFriend(pid);EventHandler.signal("friend_removed",pid);}else new UserMessage("Friend could not be removed",UserMessage.TYPE_ERROR).show();});}).addButton("no").show();}).css({'cursor':'pointer','position':'relative','bottom':'1px'});}
var appendPlayerToTable=function(table,pid){var pLog=playerLogs[pid];var totalAmount,logToolTip,currentText,currentDate;if(pLog===undefined){totalAmount=0;logToolTip=$('<a>').attr('title','<div>Player did not send you any currency yet.</div>').text(' ('+totalAmount+')');}
else
{totalAmount=pLog.total;logToolTip=$('<a>').attr('title','<div><center><b>Dates you received currency from:</b> </br>').text(' ('+totalAmount+')');for(var i=0;i<playerLogs[pid].frequency.length;i++){currentText=logToolTip.attr('title');currentDate=new Date(playerLogs[pid].frequency[i]*1000);if(i==playerLogs[pid].frequency.length-1)
logToolTip.attr('title',currentText+'<br>'+currentDate.toDateTimeStringNice()+'</center></div>');else
logToolTip.attr('title',currentText+'<br>'+currentDate.toDateTimeStringNice());}}
table.appendRow().appendToCell(-1,'remove-link',generateDeleteFriendLink(pid)).appendToCell(-1,'player-names',generatePlayerLink(pid)).appendToCell(-1,'total-received',logToolTip);if(timeUntilSesReady(pid)){var totalSec=timeUntilSesReady(pid);var hours=parseInt(totalSec / 3600)%24;var minutes=parseInt(totalSec / 60)%60;var formattedTime=$('<a>').attr('title','<div><b>Time remaining until you can send</b></div>').text(hours+'h'+minutes+'m');table.appendToCell(-1,'send-links',formattedTime);}else{table.appendToCell(-1,'send-links',generateSendLink(pid));}};function openWindow(){processLogs(false).then(function(){var players=[];$.each(friends,function(pid){players.push({'id':pid,'timeUntilReady':timeUntilSesReady(pid)});});players.sort(function(a,b){return a.timeUntilReady-b.timeUntilReady;});var windowContent=new west.gui.Scrollpane();var friendsTable=new west.gui.Table();friendsTable.addColumn('remove-link');friendsTable.addColumn('player-names').appendToCell('head','player-names','<img src="//westzzs.innogamescdn.com/images/icons/user.png" alt="" />&nbsp;'+'Name');friendsTable.addColumn('total-received').appendToCell('head','total-received','Received');friendsTable.addColumn('send-links').appendToCell('head','send-links','Send');for(var i=0;i<players.length;i++)
appendPlayerToTable(friendsTable,players[i].id);var moreData="";$.each(dropTypeLogs,function(key){moreData+='<b>'+key+':</b> '+dropTypeLogs[key]+'; ';});windowContent.appendContent(friendsTable.divMain);windowContent.appendContent(moreData);wman.open('twbf','twbf','noreload').setTitle('TW Best Friends').appendToContentPane(windowContent.divMain).setMiniTitle('TW Best Friends - Sending currency made easier!').setSize('500','420');});}
var styling=$('<style></style>').text('.remove-link { width:20px; } .player-names { width:175px; } .total-received { text-align:center; width:50px; } .send-links { text-align:right; width:170px }');$('head').append(styling);function initialiseButton(){var icon=$('<div></div>').attr({'title':'TW Best Friends','class':'menulink'}).css({'background':'url(https://puu.sh/nkN3l/aba1b474e5.png)','background-position':'0px 0px'}).mouseleave(function(){$(this).css("background-position","0px 0px");}).mouseenter(function(e){$(this).css("background-position","25px 0px");}).click(openWindow);var fix=$('<div></div>').attr({'class':'menucontainer_bottom'});$("#ui_menubar .ui_menucontainer :last").after($('<div></div>').attr({'class':'ui_menucontainer','id':'twbf'}).append(icon).append(fix));}
function initialiseCounter(){$('.xsht_custom_unit_counter').remove()
var evAvailable=$('<span></span>').attr('id','twbf_value').text(getSesReadyCount());var evLimit=$('<span></span>').attr('class','twbf_limit').text(' / '+getFriendCount()).css({'color':'lightgray','font-size':'11px'});var timeUntilCanSend=getSesSmalestTimer();var hours=parseInt(timeUntilCanSend / 3600)%24;var minutes=parseInt(timeUntilCanSend / 60)%60;console.log(timeUntilCanSend+'; '+hours+'h'+minutes+'m'+'; '+(timeUntilCanSend%60+1)*1000);var formattedTime=$('<span></span>').css({'position':'absolute','left':'3px','top':'1px','font-size':'12px'}).attr({'title':'<div><b>Time remaining until you can send</b></div>','id':'twbf_timer'}).text(' ');var evValue=$('<div></div>').attr('class','value').css({'position':'absolute','left':'32px','top':'3px','width':'105px','height':'25px','line-height':'25px','pading':'0 5px','color':'#f8c57c','font-size':'13pt','text-align':'right','user-select':'none','background':'url("https://westzzs.innogamescdn.com/images/interface/custom_unit_counter_sprite.png?2") no-repeat 0 -36px','z-index':'1'}).html(evAvailable).append(evLimit);evValue.append(formattedTime);if(timeUntilCanSend!=0){$('#twbf_timer').text(hours+'h'+minutes+'m');setTimeout(updateCounterTimer,(timeUntilCanSend%60+1)*1000);}
var evCounter=$('<div></div>').attr({'class':'xsht_custom_unit_counter','id':'twbf','title':'Open TW Best Friends'}).css({'position':'absolute','top':'32px','left':'50%','margin-left':'-250px','z-index':'16','width':'180px','height':'36px','text-align':'left','text-shadow':'1px 1px 1px #000','background':'url("https://westzzs.innogamescdn.com/images/interface/custom_unit_counter_sprite.png?2") no-repeat 50% 0','cursor':'pointer'}).append(evValue).click(openWindow);$("#ui_topbar").before(evCounter);}
function updateCounter(){WestUi.TopBar._redraw($("#twbf_value"),getSesReadyCount());$('.twbf_limit').text(' / '+getFriendCount());}
function updateCounterTimer(){var timeUntilCanSend=getSesSmalestTimer();var hours=parseInt(timeUntilCanSend / 3600)%24;var minutes=parseInt(timeUntilCanSend / 60)%60;console.log(timeUntilCanSend+'; '+hours+'h'+minutes+'m'+'; '+(timeUntilCanSend%60+1)*1000);if(timeUntilCanSend==0){updateCounter();$('#twbf_timer').text(' ');return;}else{$('#twbf_timer').text(hours+'h'+minutes+'m');setTimeout(updateCounterTimer,(timeUntilCanSend%60+1)*1000);}}
function registerToWestApi(){scriptInfo="What are you doing here?";window.scriptyscript={script:TheWestApi.register('twbf','The West Best Friends','2',Game.version.toString(),'xShteff, Diggo11','https://xshteff.github.io'),setGui:function(){this.script.setGui(scriptInfo);},init:function(){this.setGui();}};window.scriptyscript.init();}
initialiseScript();registerToWestApi();